<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline evaluation: Replication of Li et al 2010 • contextual</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Offline evaluation: Replication of Li et al 2010">
<meta property="og:description" content="contextual">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">contextual</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.8.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/cmabs.html">Demo: Basic Synthetic cMAB Policies</a>
    </li>
    <li>
      <a href="../articles/cmabsoffline.html">Demo: Offline cMAB LinUCB evaluation</a>
    </li>
    <li>
      <a href="../articles/eckles_kaptein.html">Demo: MAB Replication Eckles &amp; Kaptein (Bootstrap Thompson Sampling)</a>
    </li>
    <li>
      <a href="../articles/epsilongreedy.html">Demo: Basic Epsilon Greedy</a>
    </li>
    <li>
      <a href="../articles/introduction.html">Getting started: running simulations</a>
    </li>
    <li>
      <a href="../articles/mabs.html">Demo: MAB Policies Comparison</a>
    </li>
    <li>
      <a href="../articles/ml10m.html">Demo: MovieLens 10M Dataset</a>
    </li>
    <li>
      <a href="../articles/offline_depaul_movies.html">Demo: Offline cMAB: CarsKit DePaul Movie Dataset</a>
    </li>
    <li>
      <a href="../articles/replication.html">Offline evaluation: Replication of Li et al 2010</a>
    </li>
    <li>
      <a href="../articles/simpsons.html">Demo: Bandits, Propensity Weighting &amp; Simpson's Paradox in R</a>
    </li>
    <li>
      <a href="../articles/sutton_barto.html">Demo: Replication Sutton &amp; Barto, Reinforcement Learning: An Introduction, Chapter 2</a>
    </li>
    <li>
      <a href="../articles/website_optimization.html">Demo: Replication of John Myles White, Bandit Algorithms for Website Optimization</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li>
  <a href="../articles/only_pkgdown/faq.html">FAQ</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Nth-iteration-labs/contextual">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="replication_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Offline evaluation: Replication of Li et al 2010</h1>
                        <h4 class="author">Robin van Emden</h4>
            
            <h4 class="date">2020-07-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Nth-iteration-labs/contextual/blob/master/vignettes/replication.Rmd"><code>vignettes/replication.Rmd</code></a></small>
      <div class="hidden name"><code>replication.Rmd</code></div>

    </div>

    
    
<p>In the current vignette, we demonstrate how <code>contextual</code> facilitates the comparison of bandit policies on big offline datasets by running a partial replication of “<a href="https://arxiv.org/abs/1003.0146">A Contextual-Bandit Approach to Personalized News Article Recommendation</a>” by Li et al 2010. This paper describes how the authors made use of offline Yahoo! click-through rate data to evaluate and compare the effectiveness of several context-free and contextual policies.</p>
<p>All source code related to this replication can be found in the package’s <code>demo/replication_li_2010</code> directory.</p>
<div id="description-of-the-data" class="section level4">
<h4 class="hasAnchor">
<a href="#description-of-the-data" class="anchor"></a>Description of the data</h4>
<p>The dataset used in the Li et al 2010 paper has been made available at the Yahoo! lab’s website (At <a href="https://webscope.sandbox.yahoo.com/catalog.php?datatype=r&amp;did=49" class="uri">https://webscope.sandbox.yahoo.com/catalog.php?datatype=r&amp;did=49</a>). It contains the click-through rate from the Today news module on Yahoo!’s homepage over the course of several days in May 2009, totaling 45,811,883 separate events.</p>
<p>Each row in the dataset describes an interaction event (click or no click) of users shown a randomly chosen article. Each of these events contains the following information:</p>
<ul>
<li>The ID’s of each of a varying subset of 19 to 25 articles selected by human editors from a pool of 217 articles.</li>
<li>The ID of an article randomly chosen from the subset defined in 1. and positioned at the story position (that is, at the top of the Yahoo!’s website’s “Today” segment).</li>
<li>Six features per article for each of the articles shown.</li>
<li>Six user features (with a distinct user for each event).</li>
<li>Whether or not a user clicked on the article at the story position.</li>
</ul>
<p>That is, for each event <span class="math inline">\(t\)</span> an article represents one of <span class="math inline">\(A\)</span> actions (that is, one of the 271 articles observed within the course of the 10 days covered by the dataset) with <span class="math inline">\(\mathbb{R}^6\)</span> features <span class="math inline">\(X_{t,a}\)</span> per arm, and another <span class="math inline">\(\mathbb{R}^6\)</span> features <span class="math inline">\(X_{t,u}\)</span> per unique visitor. Together, the flattened outer product of the user and article feature vector creates a <span class="math inline">\(\mathbb{R}^{36}\)</span> feature vector <span class="math inline">\(X_t\)</span> for each user and article pair with outcome value or reward <span class="math inline">\(r_t\)</span> click (1) or no click (0). For the further details on the data structure and the general setup of the experiment, we refer the reader to the original Li et al 2010 paper.</p>
</div>
<div id="data-import" class="section level4">
<h4 class="hasAnchor">
<a href="#data-import" class="anchor"></a>Data import</h4>
<p>As the Yahoo data is too large to fit into memory, we imported the dataset’s CSV files into a <code>MonetDB</code> instance—a fast, open source column-oriented database management system with excellent R support (MonetDB can be downloaded at <a href="https://www.monetdb.org/" class="uri">https://www.monetdb.org/</a>). The import script, example import scripts for several other databases (<code>MySQL</code>, <code>SQLite</code>, <code>Postgresql</code>) and all other source code related to this replication can be found in the package’s <code>demo/replication_li_2010</code> directory.</p>
</div>
<div id="custom-bandit-and-policies" class="section level4">
<h4 class="hasAnchor">
<a href="#custom-bandit-and-policies" class="anchor"></a>Custom bandit and policies</h4>
<p>With the Yahoo! data imported into the MonetDB server, the next step was to create a custom offline <code>YahooBandit</code> plus seven <code>Policy</code> subclasses implementing the policies described in the Li et al 2010 paper. Though most of these policies were already implemented in <code>contextual</code>, the fact that only a subset of all 271 articles or arms are shown to a visitor at a time meant we needed to make some minor changes to <code>contextual</code>’s exisiting classes to make the policies run smoothly on a continually shifting pool of active arms.</p>
<p>To facilitate these shifting arms, <code>YahooBandit</code> makes use of an <code>self$arm_lookup</code> table listing all 271 arms. This table enables the bandit to look up the currently active arms’ indexes from the shifting set of article ID’s as specified in the dataset for each time step <span class="math inline">\(t\)</span>, and return these indexes to the policies under evaluation:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r">    <span class="no">get_context</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">index</span>) {
      <span class="no">...</span>
      <span class="co"># Retrieve the index of all arms this row/event.</span>
      <span class="no">arm_indices_this_event</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">10</span>, <span class="fl">184</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">7</span>)
      <span class="no">article_ids</span>             <span class="kw">&lt;-</span> <span class="no">row</span>[<span class="no">arm_indices_this_event</span>]
      <span class="no">article_ids</span>             <span class="kw">&lt;-</span> <span class="no">article_ids</span>[!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">article_ids</span>)]
      <span class="no">article_ids</span>             <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="no">article_ids</span>,<span class="no">self</span>$<span class="no">arm_lookup</span>)
      <span class="no">...</span>
      <span class="no">context</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
        <span class="kw">k</span> <span class="kw">=</span> <span class="no">self</span>$<span class="no">k</span>,
        <span class="kw">d</span> <span class="kw">=</span> <span class="no">self</span>$<span class="no">d</span>,
        <span class="kw">unique</span> <span class="kw">=</span> <span class="no">self</span>$<span class="no">unique</span>, <span class="co"># Indexes of disjoint arms (user features)</span>
        <span class="kw">shared</span> <span class="kw">=</span> <span class="no">self</span>$<span class="no">shared</span>, <span class="co"># Indexes of shared arms (article features)</span>
        <span class="kw">arms</span> <span class="kw">=</span> <span class="no">article_ids</span>,   <span class="co"># Indexes of arms this event.</span>
        <span class="kw">X</span> <span class="kw">=</span> <span class="no">X</span>
      )
    }</pre></body></html></div>
<p>The policy classes then use this information to select and update only the currently active subset of arms. For instance, in <code>YahooEpsilonGreedyPolicy</code>’s <code><a href="../reference/Policy.html">get_action()</a></code>:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r">    <span class="no">get_action</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">t</span>, <span class="no">context</span>) {
      <span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>) <span class="kw">&gt;</span> <span class="no">self</span>$<span class="no">epsilon</span>) {
        <span class="co"># get the max of context$arms *currently in play*</span>
        <span class="no">max_index</span>          <span class="kw">&lt;-</span> <span class="no">context</span>$<span class="no">arms</span>[<span class="fu">max_in</span>(<span class="no">theta</span>$<span class="no">mean</span>[<span class="no">context</span>$<span class="no">arms</span>])]
        <span class="no">self</span>$<span class="no">action</span>$<span class="no">choice</span> <span class="kw">&lt;-</span> <span class="no">max_index</span>
      } <span class="kw">else</span> {
        <span class="co"># sample from the arms *currently in play*</span>
        <span class="no">self</span>$<span class="no">action</span>$<span class="no">choice</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">context</span>$<span class="no">arms</span>, <span class="fl">1</span>)
      }
      <span class="no">self</span>$<span class="no">action</span>
    }</pre></body></html></div>
<p>On completing the implementation of the aforementioned seven custom policy subclasses (<code>Random</code>, <code>EGreedy</code>, <code>EGreedySeg</code>, <code>LinUCBDis</code>, <code>LinUCBHyb</code>, <code>UCB1</code> and <code>UCB1Seg</code>) we then assigned them to six simulations—one for each of the six (0, 30, 20, 10, 5 and 1 percent) levels of sparsity defined in the original paper. This resulted in <span class="math inline">\(7\times6=42\)</span> Agents, which were then run on the offline dataset as follows:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">simulations             &lt;- 1
horizon                 &lt;- 37.45e6
...
con &lt;- DBI::dbConnect(MonetDB.R(), host=monetdb_host, dbname=monetdb_dbname,
                                   user=monetdb_user, password=monetdb_pass)

message(paste0("MonetDB: connection to '",dbListTables(con),"' succesful!"))

arm_lookup_table &lt;-
  as.matrix(DBI::dbGetQuery(con, "SELECT DISTINCT article_id FROM yahoo"))

arm_lookup_table &lt;- rev(as.vector(arm_lookup_table))

bandit &lt;- YahooBandit$new(k = 217L, unique = c(1:6), shared = c(7:12),
                          arm_lookup = arm_lookup_table, host = monetdb_host,
                          dbname = monetdb_dbname, user = monetdb_user,
                          password = monetdb_pass, buffer_size = buffer_size)

agents &lt;-
  list (Agent$new(YahooLinUCBDisjointPolicy$new(0.2),
                  bandit, name = "LinUCB Dis",  sparse = 0.99),
        Agent$new(YahooLinUCBHybridPolicy$new(0.2),
                  bandit, name = "LinUCB Hyb",  sparse = 0.99),
        Agent$new(YahooEpsilonGreedyPolicy$new(0.3),
                  bandit, name = "EGreedy",     sparse = 0.99),
        Agent$new(YahooEpsilonGreedySegPolicy$new(0.3),
                  bandit, name = "EGreedySeg",  sparse = 0.99),
        Agent$new(YahooUCB1AlphaPolicy$new(0.4),
                  bandit, name = "UCB1",        sparse = 0.99),
        Agent$new(YahooUCB1AlphaSegPolicy$new(0.4),
                  bandit, name = "UCB1Seg",     sparse = 0.99),
        ...
        Agent$new(YahooRandomPolicy$new(),
                  bandit, name = "Random"))

simulation &lt;- Simulator$new(
    agents,
    simulations = simulations,
    horizon = horizon,
    do_parallel = TRUE,
    worker_max = worker_max,
    reindex = TRUE,
    progress_file = TRUE,
    include_packages = c("MonetDB.R"))

history  &lt;- simulation$run()
...</pre></body></html></div>
</div>
<div id="results" class="section level4">
<h4 class="hasAnchor">
<a href="#results" class="anchor"></a>Results</h4>
<p>We were able to complete the full <span class="math inline">\(7\times6=42\)</span> agent simulation over all of the 37,450,196 events in our database within 22 hours on a 64 core Intel Xeon Unbuntu server with 256GB of memory. We then proceeded to analyse the results of the first 4.7 million events (following the original paper, representing about a day worth of events) to reproduce Li et al 2010’s Figure 4b: “CTRs in evaluation data with varying data sizes in the learning bucket.”. Just like the original paper, the replicated figure below reports each algorithm’s relative CTR for all of the defined data sparsity levels, that is, each algorithm’s CTR divided by the random policy’s CTR.</p>
<p><img src="replication-fig-1.png" style="width:98.0%"></p>
<p><em>Replication of Figure 4b “CTRs in evaluation data with varying data sizes in the learning bucket.” from Li et al 2010. The plots represent the click through rates for different policies after one day of learning for each of six different levels of sparsity.</em></p>
<p>As can be observed in the next figure, after one day of learning (on the Yahoo! dataset’s day three), the conclusions of the original paper still stand. First, features again prove to be of use at all levels of sparsity, as LinUCB policies outperform the others consistently. Second, UCB policies generally outperform <span class="math inline">\(\epsilon\)</span>-greedy ones. And third, Hybrid LinUCB shows benefits when the data is small, as it does even better relative to Disjoint LinuCB in the 1% bucket.</p>
<p>To explore a little further, we also run a simulation that continued to learn beyond the first day for the sparse (1%) data condition to test—for the results, see the final figure.</p>
<p><img src="replication-fig-2.png" style="width:98.0%"></p>
<p><em>A plot of the cumulative reward rate (equals click-through rate) for EGreedy, EGreedySeg, LinUCB Dis, LinUCB Hyb, UCB1, and UCB1Seg policies over eight days of events from the Yahoo dataset at 1% sparsity. The dotted lines represent blocks consisting of 24 hours worth of data—the lines are not equidistant as the number of data points of these 24 hours differs per block. The plot’s sinusoidal wave pattern reflects visitors’ overall average cyclical daily waxing and waning click-through tendency.</em></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robin van Emden.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '7d3ef95d72d5a68e705ce87f9919b959',
    indexName: 'nth_iteration_labs_contextual',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
